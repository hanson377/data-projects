---
title: "Modeling and prediction for movies"
output:
  github_document:
    fig_width: 9
    fig_height: 4
---

## Setup

### Load packages

```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
library(statsr)
library(ggcorrplot)
library(lubridate)
```

### Load data
```{r load-data}
load("~/GitHub/data-projects/movie project/movies.Rdata")

```



* * *

## Part 1: Data
The data here is a random sample of movies created before 2016.  This implies we can likely generalize trends and relationships found in our analysis to the broader population of all movies before 2016.

However, I'm concerned that the data here is a bit imbalanced across time and identifying a time period for which we can generalize our results across is a bit difficult.  For example, our data only goes back to 1970.  This means that, at best, we can only generalize our results from 1970 forward.

Furthermore, if we have more movies existing in more recent years than previous years, I'd wonder how much we can actually generalize what we find to the entire population of movies between 1970 and 2016.  It seems to be the case that the number of movies in the dataset per year increases across time.  For example, we have one movie listed in 1970 and 26 in 2012.  This leads me to believe that it is somewhat unlikely we can actually generalize our results to the general population of movies between 1970 and 2016.  However, for the purpose of this exercise, we will assume we can.

Additionally, this data exists outside of an experimental setting, and thus causal relationships cannot be made.

* * *

## Part 2: Research question
First, I'd like to understand if critics scores deviate from that of the audience.  If so, in what direction?  Are critics more likely to rate movies lower than the audience?  If so, is there anything that we can find to explain these deviations?

I'd then like to build a model that can predict how different a critics score will be from the audience.  


* * *

## Part 3: Exploratory data analysis
First, lets get a general feel for what the data looks like.  

Namely, I'm interested in understanding the time-series element of this dataset.  I'd like to understand how our movie volume changes across time and then understand if the average rating has changed across time. I'd also like to understand how the scores across our different categories (imdb, audience, critic) correlate and/or differ across time.

The answers to these questions will greatly inform our answer to our research question.  It will help us also understand if we need to add some temporal component to our predictive model at the end of this exercise.

First, let us look at the volume of movies across time.

```{r quick survey of the data}
ts_summary <- movies %>% group_by(thtr_rel_year) %>% summarise(movies = n_distinct(title),
                                                              mean_imdb_rating = mean(imdb_rating),
                                                              median_imdb_rating = median(imdb_rating),
                                                              mean_critic_score = mean(critics_score),
                                                              median_critic_score = median(critics_score),
                                                              mean_audience_score = mean(audience_score),
                                                              median_audience_score = median(audience_score))

imdb <- ts_summary %>% select(thtr_rel_year, mean = mean_imdb_rating, median = median_imdb_rating)
imdb$sample <- 'imdb score'

critic <- ts_summary %>% select(thtr_rel_year, mean = mean_critic_score, median = median_critic_score)
critic$sample <- 'critic score'

audience <- ts_summary %>% select(thtr_rel_year, mean = mean_audience_score, median = median_audience_score)
audience$sample <- 'audience score'

summary <- rbind(critic,audience)
summary$mean <- round(summary$mean/10,digits=2)
summary$median <- round(summary$median/10, digits=2)

summary <- rbind(summary,imdb)

ggplot(ts_summary, aes(x=thtr_rel_year, y=movies)) + geom_line() + theme(legend.position="bottom", legend.title = element_blank())
ggplot(summary, aes(x=thtr_rel_year, y=median, color=sample)) + geom_line() + theme(legend.position="bottom", legend.title = element_blank())
ggplot(summary, aes(x=thtr_rel_year, y=mean, color=sample)) + geom_line() + theme(legend.position="bottom", legend.title = element_blank())
```

We've learned a few important things from above.  

First, as I suspected, I'm not sure our sample is representative across time.  We seem to have much more movies in our data from recent years than older years.

Secondly, we can see that outside of the first few years of data, audience and imdb scores are both correlative and mostly stable across time.

Thirdly, critics scores seem to not be correlative nor similar to imdb/audience scores as of late. Since 1995 or so, we've seen audience/imdb scores diverge from that of critics scores.  To simply our analysis, we are going to exclude movies released in theatre before 1995 from our analysis.

It also seems to be that median/mean scores aren't incredibly different.  This means we might not have too many outliers when summarizing by year.

Okay, now we that understand some basics of the data, lets begin exploring our research question. First, lets look at how much a critic's score and an audience's score deviate.  Lets look at the distribution of this deviation.

```{r deviation exploration}
movies <- subset(movies, thtr_rel_year >= 2000)
movies <- movies %>% mutate(diff = (critics_score-audience_score))
summary <- movies %>% summarise(mean_diff = mean(diff), median_diff = median(diff))
summary

ggplot(data=movies, aes(x=diff)) + geom_histogram()

upper_diff = quantile(movies$diff, .975)
lower_diff = quantile(movies$diff, .025)

movies <- subset(movies, diff > lower_diff & diff < upper_diff)

ggplot(data=movies, aes(x=diff)) + geom_histogram()

```

From the above, we can see that this distribution is left-skewed.  This implies that a critic is more likely to rate a movie below the audience.  This is confirmed with the fact that the mean sits farther to the left than the median.

For the next section of my analysis, I'm going to attempt to identify other continuous variables that are correlated to our differential variable.

```{r deviation correlations }
## audience score
ggplot(data=movies, aes(x=diff, y=audience_score)) + geom_point()
lm <- lm(data=movies, diff ~ audience_score)
summary(lm)

## imdb num votes (or popularity)
upper = quantile(movies$imdb_num_votes, .95)
lower = quantile(movies$imdb_num_votes, .05)
movies_alt <- subset(movies, imdb_num_votes < upper & imdb_num_votes > lower)

ggplot(data=movies_alt, aes(x=diff, y=imdb_num_votes)) + geom_point()
lm <- lm(data=movies_alt, diff ~ imdb_num_votes)
summary(lm)

## runtime
movies <- subset(movies, runtime > 40)
ggplot(data=movies, aes(x=diff, y=runtime)) + geom_point()
lm <- lm(data=movies, diff ~ log(runtime))
summary(lm)

## days between theatre release and dvd release
movies$thtr_date <- as.Date(with(movies, paste(thtr_rel_year, thtr_rel_month, thtr_rel_day,sep="-")), "%Y-%m-%d")
movies$dvd_date <- as.Date(with(movies, paste(dvd_rel_year, dvd_rel_month, dvd_rel_day,sep="-")), "%Y-%m-%d")
movies$date_diff <- as.numeric(difftime(movies$dvd_date,movies$thtr_date, units='weeks'))
summary(movies$date_diff)

ggplot(data=movies, aes(x=date_diff)) + geom_histogram()
movies <- subset(movies, date_diff >= 0) ## remove strange case where dvd release is before theatre release
ggplot(data=movies, aes(x=date_diff)) + geom_histogram()

year <- movies %>% group_by(thtr_rel_year) %>% summarise(mean = mean(date_diff), median = median(date_diff))
ggplot(data = year, aes(x=thtr_rel_year, y = mean)) + geom_line(stat='identity')
ggplot(data = year, aes(x=thtr_rel_year, y = median)) + geom_line(stat='identity')


upper = quantile(movies$date_diff, .975)
lower = quantile(movies$date_diff, .025)
movies_alt <- subset(movies, date_diff < upper & date_diff > lower)

ggplot(data=movies_alt, aes(x=diff, y=date_diff)) + geom_point()
lm <- lm(data=movies, diff ~ date_diff)
summary(lm)
```

From the above, we find an interesting trend shown by the scatterplot of audience score and our critic score differential.  As audience score decreases, our differential also decreases.  This implies that if we were to use this in our predictive model, we would violate the assumption of homoskedasticity, as the expected variation decreases as audience score decreases.  This trend makes sense, as the possible values our deviation can increases and decreases as audience score fluctuates.

From the above, we also find that movie runtime is a significant predictive power for explaining a negative differential, although pretty small.

Now lets explore deviations across a few demographics.  Namely, lets look at MPAA rating, genre, release year, release month.

```{r deviations by demographics}
genre <- movies %>% group_by(genre) %>% summarise(movies = n_distinct(title), median = median(diff), mean = mean(diff), iqr = IQR(diff))
genre
ggplot(data=movies, aes(x=genre, y=diff)) + geom_boxplot()
lm <- lm(data=movies, diff ~ genre)
summary(lm)

mpaa_rating <- movies %>% group_by(mpaa_rating) %>% summarise(movies = n_distinct(title), median = median(diff), mean = mean(diff), iqr = IQR(diff))
mpaa_rating
ggplot(data=movies, aes(x=mpaa_rating, y=diff)) + geom_boxplot()
lm <- lm(data=movies, diff ~ mpaa_rating)
summary(lm)

year <- movies %>% group_by(thtr_rel_year) %>% summarise(movies = n_distinct(title), median = median(diff), mean = mean(diff), iqr = IQR(diff))
year
ggplot(data=movies, aes(x=factor(thtr_rel_year), y=diff)) + geom_boxplot()
lm <- lm(data=movies, diff ~ thtr_rel_year)
summary(lm)

month <- movies %>% group_by(thtr_rel_month) %>% summarise(movies = n_distinct(title), median = median(diff), mean = mean(diff), iqr = IQR(diff))
month
ggplot(data=movies, aes(x=factor(thtr_rel_month), y=diff)) + geom_boxplot()
lm <- lm(data=movies, diff ~ factor(thtr_rel_month))
summary(lm)

day <- movies %>% group_by(thtr_rel_day) %>% summarise(movies = n_distinct(title), median = median(diff), mean = mean(diff), iqr = IQR(diff))
day
ggplot(data=movies, aes(x=factor(thtr_rel_day), y=diff)) + geom_boxplot()
lm <- lm(data=movies, diff ~ factor(thtr_rel_day))
summary(lm)
```

We again find some interesting trends from the above.  These are, in no particular order, as follows:

1. Action and Adventure, Animation, and Comedy movies seem to have the largest negative deviations between critic and audience scores.  Documentaries, sci-fi, and mystery movies have some of the smallest deviations.  This might imply that some movies attract a different type of audience, some of which are slightly more critical than the average movie-goer.

2. Unrated movies are the only movies in our dataset with a positive deviation, on average.  All other ratings have similar negative deviations.

3.The month of a movie's theatre release doesn't seem to be a significant predictor of a deviation between a critic and the audience scores.

4. The day of a theatre release doesn't seem to be associated with the deviation between an audience and critics score.

5. The difference in weeks between a theatre release date and dvd release date doesn't seem to have significant predictive power.r

* * *

## Part 4: Modeling

```{r backward elimination r2}
lm1 <- lm(data=movies, diff ~  factor(genre) + factor(mpaa_rating) + log(runtime) + log(imdb_num_votes) + log(date_diff))
summary(lm1)

lm1 <- lm(data=movies, diff ~  factor(genre) + factor(mpaa_rating) + log(runtime) + log(date_diff))
summary(lm1)

lm1 <- lm(data=movies, diff ~  factor(genre) + factor(mpaa_rating) + log(runtime))
summary(lm1)

lm1 <- lm(data=movies, diff ~  factor(genre) + log(runtime))
summary(lm1)

lm1 <- lm(data=movies, diff ~  factor(genre) + factor(mpaa_rating) + log(runtime))
summary(lm1)
```

Above, we fitted a model using R^2 Backward Elimination.  I started with a full-model including all of the variables that were shown to be significant predictors above.  I then removed the model with the smallest p-value in each around and watched how the adjusted R^2 value changed each time I did that.  Adjusted R^2 increased for every variable I removed until I attempted to remove MPAA Rating near the end of my model selection.  When I did this, my adjusted R^2 actually decreased from the prior model, so I folded it back in.



Now that we have a model, lets run some diagnostics on it.  We want to check for:
a. linear relationship between x and y
b. nearly normal residuals
c. constant variability of residuals
d. independence of residuals

First, lets check for a linear relationship between X and Y.

```{r linear relationship}
plot(lm1$residuals ~ log(movies$runtime))
```

Looks like our residuals are randomly scattered around zero.  We have met this condition.  

Now lets look at the condition of nearly normal residuals.  To do this, we will plot a histogram of the residuals and check for normality and a mean around zero.

```{r normal residuals}
hist(lm1$residuals)
```

It looks like we have clearly satisfied the condition of nearly normal residuals, as the distribution is centered at zero and is distributed normally around it.

Now, lets check for the constant variability of residuals.  We will do this by plotting the residuals with the fitted and check for random scatter here.

```{r constant variability}
plot(abs(lm1$residuals) ~ abs(lm1$fitted))
```

Again, it looks this like condition is satisfied!  

Lets move onto the last condition...independence of residuals.

```{r ind of residuals}
plot(lm1$residuals)
```

These are randomly scattered.  Thus, all assumptions are satisfied and our model is valid!

* * *

## Part 5: Prediction
We are going to see what values we predict for the 2016 movie 'Arrival'.  This was a movie that seemed to receive a lot of attention from critics, but less attention and praise from the general population.  

```{r prediction value}
model <- movies %>% select(title, genre, mpaa_rating, runtime)
model <- add_row(model, title = 'Arrival', genre = 'Science Fiction & Fantasy', mpaa_rating = 'PG-13', runtime = 118)
arrival <- subset(model, title == 'Arrival')

predict(lm1, newdata = arrival, interval = "confidence")
```

From the above, we can see that we are predicting a difference of nearly zero with a confidence interval of between -18.6 and +19.3.  This means we are 95% confident that, on average and with all else held equal, the difference between the critic score and audience scores for the movie Arrival lies between -18.6 and 19.3.  



* * *

## Part 6: Conclusion
In conclusion, we have built a significant model for predicting the difference in the critic score and audience score for any movie made after 2000.  However, the adjusted R^2 implies that we can only explain about 8% of the variability in the difference between an audience and critic score for a movie.  

This implies that it is likely to be the case that there are other variables we need to bring into our model to better predict this model.  Unfortunately, we are only given a small set of variables for this project.

Regardless, we discovered some interesting explanatory variables that we will be able to report back to our boss at Paramount Pictures.
