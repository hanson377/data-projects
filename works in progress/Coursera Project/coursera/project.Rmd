---
title: "Exploring the BRFSS data"
output:
  html_document:
    fig_width: 8
    highlight: pygments
    theme: spacelab
---

## Setup

### Load packages

```{r load-packages, message = FALSE}
library(ggplot2)
library(dplyr)
```

### Load data

```{r load-data}
load("/Users/joshuahanson/Desktop/coursera/brfss2013.RData")
```



* * *

## Part 1: Data
This survey seems to be overseen by the CDC but is carried out by certain organizations within every state.  Survey results generally draw from two samples: (1) a landline sample and (2) a cellular telephone sample.
The landline sample is a disproportionate stratified sample while the cellular telephone sample is 'randomly generated from a sampling frame of confirmed cellular area code and prefix combinations'.  

This means that the landline group is divided into distinct populations and random samples are drawn from those populations of interest while the cellular sample is a simple random survey.

Given that this is a survey and thus contains only observational data, we cannot draw any causative relationships between whatever variables we examine.  Only experimental data allows us to do that.

However, since these samples are drawn randomly, and population-weighting efforts are carried out to correct for any sampling bias, we can probably conclude that the results here are relatively generalizable.  The BRFSS Data User guide explicitly states that new weighting protocols since 2011 have ensured that "data are representative of the population on a number of demographic characteristics including sex, age, race, education, marital status, home ownership, phone ownership, and sub-state region."  However, a researcher might be leery of this assumption, as this survey is carried out via phone land lines and cellular phones.  Survey groups like this could be classified as a convenience sample, and thus might contain some sampling bias.
* * *

## Part 2: Research questions

**Research question 1:**
First, I'd like to explore the the frequency of mental health issues across a few top-level demographics.  Namely, I'd like to explore how mental health is impacted by gender and income levels.  I want see if mental health issues are different across genders.  I also want to explore the hypothesis that higher level of incomes perhaps decrease mental health issues, as presumably these individuals have more access to healthcare services and are exposed to less financial stress.

**Research question 2:**
Second, I'm going to examine how BMI differs across some key demographics.  Namely, I'd like to look at how BMI is related to alcohol consumption, education levels, and current employment status.  I hypothesize that BMI is positively correlated with alcohol consumption, negatively correlated with education levels, and that employed individuals are likely to have lower BMIs than those unemployed.

**Research question 3:**
Lastly, I'd like to explore how access to healthcare access is related to gender and income.  Although I don't foresee healthcare access differing much by gender, it will be worth checking out.  I do expected healthcare access to be negatively correlated with income.  I'd hypothesize with higher levels of income are much more likely to be able to afford insurance, and thus, have access to healthcare.

* * *

## Part 3: Exploratory data analysis

**Research question 1:**
I'm going to use menthlth as my variable for measuring mental health.  This variable is simply the number of days within the past 30 that a respondent reported feeling stress, depression, and/or problems with emotions.

First, lets ensure the values for our key variable are as we might expect.  Our variable of interest, menthlth, should only take values 0-30.

```{r, fig.width=8}
summary(brfss2013$menthlth)
```

It looks like we have some messy data, as we have some values much larger than 30.  Lets subset the data to only include values we might expect.

```{r, fig.width=8}
mental_data <- subset(brfss2013, menthlth <= 30)
summary(mental_data$menthlth)
```

Great! Now lets get an idea for the distribution of this data. I'm gonna look at both the cumulative distribution of the data, as well as various percentiles.

```{r, fig.width=8}
ggplot(mental_data, aes(menthlth)) + stat_ecdf()
quantile(mental_data$menthlth, c(.1,.70,.80,.85, .90, .95, .98, .99), na.rm=TRUE)
```

It appears as if our data is heavily skewed right, as 70% of our respondents have spent 0 or 1 days feeling depressed with the rest of the values from 2-30 making up the final 30%.
Knowing this, we will have to be careful about how we summarize our data.  Means and medians might not tell us much here.

Lets take a look at the cumulative distribution curves for our variable by sex.

```{r, fig.width = 6}
mental_data <- subset(mental_data, is.na(sex)==FALSE)
shares <- mental_data %>%
 group_by(sex,menthlth) %>%
 summarise(
   values = sum(X_llcpwt))

shares <- shares %>%
  group_by(sex)%>%
  mutate(
        sum_values=sum(values, na.rm=TRUE),
        shares = values/sum(values, na.rm=TRUE))

shares <- subset(shares, is.na(shares)==FALSE)

  shares <- shares %>%
    group_by(sex)%>%
    mutate(
          cum_share=cumsum(shares))

shares
ggplot(shares, aes(y=cum_share, x=menthlth, colour = sex)) + geom_line()
```

When we look at the cumulative distribution of values by gender, it becomes clear that there is a slight difference by sex.
The cumulative distribution curve for women sits below that of the men, implying men are less likely to report having felt a mental health issue within the past 30 days.

Now, lets look at how mental health is associated with various levels of income.

```{r, fig.width=8}
mental_data <- subset(mental_data, is.na(income2)==FALSE)
shares <- mental_data %>%
 group_by(income2,menthlth) %>%
 summarise(
   values = sum(X_llcpwt))

shares <- shares %>%
  group_by(income2)%>%
  mutate(
        sum_values=sum(values, na.rm=TRUE),
        shares = values/sum(values, na.rm=TRUE))

shares <- subset(shares, is.na(shares)==FALSE)

  shares <- shares %>%
    group_by(income2)%>%
    mutate(
          cum_share=cumsum(shares))

shares
ggplot(shares, aes(y=cum_share, x=menthlth, colour = income2)) + geom_line()
```

We have found another potentially dependent relationship.  It seems very clear that income is negatively correlated with mental health, meaning lower levels of income are associated with more frequent days with mental health issues per every 30 days.

**Research question 2:**
Now, I'd like to take a look at differences in BMI across certain demographics.

First, I'd like to look at if BMIs differ greatly across various levels of alcohol consumption.  I'll then look at how BMI differs by education levels and current employment status.

Lets create a new dataframe where avedrink2 is not null.

```{r, fig.width=8}
alc <- subset(brfss2013, is.na(avedrnk2) == FALSE)
alc <- subset(alc, is.na(weight2) == FALSE)
alc <- subset(alc, is.na(X_bmi5) == FALSE)
```

First, lets ensure the values for our key variable are as we might expect.  Lets take a look at the histogram and the cumulative distribution.

```{r, fig.width=8}
shares <- alc %>%
 group_by(avedrnk2) %>%
 summarise(
   values = n())

 shares <- shares %>%
   group_by()%>%
   mutate(
         sum_values=sum(values),
         shares = values/sum(values))

 shares <- shares %>%
   group_by()%>%
   mutate(
         cum_share = cumsum(shares)
       )
shares
ggplot(shares, aes(y=cum_share, x=avedrnk2)) + geom_line()

```
This variable seems to have some issues. 99% of our values sit below 11 drinks per day with a long tail of other values reaching as far as 76, which seems non-sensical.
Lets remove all observations with a value above 11 (or above the ~99th percentile.)

```{r, fig.width=8}
alc <- subset(alc, avedrnk2 <= 11)
summary(alc$avedrnk2)
ggplot(alc, aes(avedrnk2)) + stat_ecdf()
```

First, lets see if our BMI variable seems to be normally distributed.  If so, we can look at average weight across levels of alcohol consumption.



```{r, fig.width=8}
alc$bmi <- as.numeric(alc$X_bmi5/100) ## doing this, as BMI is currently expressed with an implied two digits.

summary <- alc %>%
 group_by() %>%
 summarise(
   mean_weight = mean(bmi),
   median_weight = median(bmi),
   sd_weight = sd(bmi))
summary

hist(alc$bmi)
```

Great, the distribution for BI is very close to normally distributed!  We can now summarize weight by various levels of alcohol consumption.  Lets take a look.

```{r, fig.width=8}
summary <- alc %>%
 group_by(avedrnk2) %>%
 summarise(
   mean_ex = mean(bmi, na.rm=TRUE)
 )
summary

ggplot(summary, aes(y=mean_ex, x=avedrnk2)) + geom_col()
```

It does not look like BMI varies greatly by levels of alcohol consumption.  This is surprising, as I would have hypothesized that higher levels of consumption are associated with higher BMIs.

Now, lets look at how BMI varies by education levels.

```{r, fig.width=8}
summary <- subset(alc, is.na(educa)==FALSE)
summary <- summary %>%
 group_by(educa) %>%
 summarise(
   mean_ex = mean(bmi, na.rm=TRUE)
 )
summary
ggplot(summary, aes(y=mean_ex, x=educa, colour=educa)) + geom_col()+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

Interesting. It looks like those with only a high school diploma have a ~5% higher BMI than those with four years or more of college education.


```{r, fig.width=8}
summary <- subset(alc, is.na(employ1)==FALSE)
summary <- summary %>%
 group_by(employ1) %>%
 summarise(
   mean_ex = mean(bmi, na.rm=TRUE)
 )
summary
ggplot(summary, aes(y=mean_ex, x=employ1, colour=employ1)) + geom_col()+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

We also find an interesting result here.  We can see that unemployed individuals (who aren't students) are associated with higher BMIs than those currently employed. I'm defining unemployed here as those who have been out of work at least one year or those whom are unable to work.

Students have the lowest BMIs, which is probably expected (as they are likely younger).

**Research question 3:**
We now want to look at how healthcare access is connected to sex, income, and location.

```{r, fig.width=8}
health <- subset(brfss2013, is.na(hlthpln1) == FALSE)
summary(health$hlthpln1)
health <- subset(health, is.na(sex) == FALSE)
health <- subset(health, is.na(income2) == FALSE)
health <- subset(health, is.na(X_llcpwt) == FALSE)

health <- health %>%
mutate(access_binary = ifelse(hlthpln1 == 'Yes', 1, 0))
```
Now we can look at our data.  Lets first see if healthcare access is different across sex.

```[r]
summary <- health %>%
 group_by(sex) %>%
 summarise(
   access_total = sum(access_binary*X_llcpwt),
   sample_size = sum(X_llcpwt),
   mean_ex = sum(access_binary*X_llcpwt)/sum(X_llcpwt))


summary <- summary %>%
 group_by(sex) %>%
 mutate(
   mean = 100*mean_ex,
   sd = sqrt(100*mean_ex*(1-mean_ex))
 )

summary <- summary %>%
 group_by(sex) %>%
 mutate(
    minus_1_sd = mean-(1*sd),
   plus_1_sd = mean+(1*sd))

summary

ggplot(data=summary, aes(x=sex, y=mean_ex))+geom_col()
```

It does not look like healthcare access varies much by sex.  We can see that if we surveyed 100 people, we would likely get values for both males and females that would fall within the expected range (+1 or -1 standard deviations).

Now, lets take a look at income.

```{r, fig.width=8}
summary <- health %>%
 group_by(income2) %>%
 summarise(
   access_total = sum(access_binary*X_llcpwt),
   sample_size = sum(X_llcpwt),
   mean_ex = sum(access_binary*X_llcpwt)/sum(X_llcpwt))


summary <- summary %>%
 group_by(income2) %>%
 mutate(
   mean = 100*mean_ex,
   sd = sqrt(100*mean_ex*(1-mean_ex))
 )

summary <- summary %>%
 group_by(income2) %>%
 mutate(
    minus_1_sd = mean-(1*sd),
   plus_1_sd = mean+(1*sd))

summary

ggplot(data=summary, aes(x=income2, y=mean_ex, colour=income2))+geom_col()+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```
It looks like healthcare access is dependent on income level.  Only around 65% of people with an income of less than 10k per year are expected to have healthcare access, compared to 97% of those making 75k or more.

Finally, lets look at healthcare access by state.

```{r}
summary <- health %>%
 group_by(X_state) %>%
 summarise(
   access_total = sum(access_binary*X_llcpwt),
   sample_size = sum(X_llcpwt),
   mean_ex = sum(access_binary*X_llcpwt)/sum(X_llcpwt))


summary <- summary %>%
 group_by(X_state) %>%
 mutate(
   mean = 100*mean_ex,
   sd = sqrt(100*mean_ex*(1-mean_ex))
 )

summary <- summary %>%
 group_by(X_state) %>%
 mutate(
    minus_1_sd = mean-(1*sd),
   plus_1_sd = mean+(1*sd))

summary <- summary %>%
 group_by() %>%
 mutate(
   state_rank = row_number(mean)
 )

summary <- subset(summary, state_rank <= 5 | state_rank >=49)
summary <- summary[order(summary$state_rank),]

summary
ggplot(data=summary, aes(x=reorder(X_state,mean), y=mean_ex, colour=X_state))+geom_col()+
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

From the above, we can see that the five states with the least levels of healthcare access are very different from those with the highest levels of coverage.  For example, only around 72% of Texas residents reported having insurance in 2013 compared to 94% of Massachusetts residents.  This might be connected to different healtchare-related policies carried out by the state as well as varying levels of income across states.
